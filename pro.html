<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #fff; margin: 0; display: flex; justify-content: center; overflow-x: hidden; }
        .pro-frame { width: 100%; max-width: 450px; min-height: 100vh; background: white; display: flex; flex-direction: column; align-items: center; position: relative; }
        
        .top-bar { width: 100%; height: 60px; background: #fff; display: flex; align-items: center; padding: 0 15px; box-sizing: border-box; justify-content: space-between; border-bottom: 1px solid #f0f2f5; }
        .back-btn { color: #0084ff; text-decoration: none; font-size: 28px; cursor: pointer; }
        .header-title { font-size: 20px; font-weight: bold; color: #000; }

        .profile-header { margin-top: 20px; text-align: center; width: 100%; }
        .avatar-container { position: relative; width: 120px; height: 120px; margin: 0 auto 15px; }
        .avatar-main { width: 120px; height: 120px; background: #0084ff; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 50px; overflow: hidden; border: 2px solid #f0f2f5; }
        .avatar-main img { width: 100%; height: 100%; object-fit: cover; }
        
        .cam-icon { position: absolute; bottom: 5px; right: 5px; background: #fff; border-radius: 50%; padding: 7px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: none; font-size: 18px; }

        .user-name { font-size: 24px; font-weight: bold; color: #000; margin-bottom: 5px; }
        .info-text { font-size: 15px; color: #65676b; margin: 3px 0; }

        .menu-list { width: 90%; margin-top: 30px; margin-bottom: 50px; }
        .menu-item { padding: 12px 15px; border-radius: 10px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; cursor: pointer; transition: 0.2s; background: #f0f2f5; }
        .menu-item:hover { background: #e4e6eb; }
        .menu-item span { font-size: 16px; color: #050505; font-weight: 500; }
        
        .edit-area { display: none; width: 90%; margin: 15px 0; background: #f9f9f9; padding: 15px; border-radius: 12px; border: 1px solid #ddd; }
        input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; outline: none; }
        .save-btn { background: #0084ff; color: white; border: none; padding: 12px; border-radius: 8px; width: 100%; cursor: pointer; font-weight: bold; }

        .delete-box { background: #fff1f1; border: 1px solid #ffcccc; margin-top: 20px; }
        .delete-box span { color: #fa3e3e !important; }

        /* ‡¶®‡ßã‡¶ü‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶¨‡¶æ‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶Æ‡¶§‡ßã‡¶á ‡¶•‡¶æ‡¶ï‡¶õ‡ßá... */
        #notif-bar { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: #0084ff; color: white; padding: 12px 15px; border-radius: 15px; display: flex; align-items: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 1000; transition: top 0.5s; cursor: pointer; }
        #notif-bar.show { top: 20px; }
    </style>
</head>
<body>

<div id="notif-bar" onclick="goToChat()">
    <div class="notif-content">
        <div class="notif-title" id="notifSender">‡¶®‡¶§‡ßÅ‡¶® ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú</div>
        <div class="notif-text" id="notifMsg">...</div>
    </div>
</div>

<div class="pro-frame">
    <div class="top-bar">
        <a href="index.html" class="back-btn">‚Äπ</a>
        <div class="header-title">‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤</div>
        <div style="width: 28px;"></div>
    </div>

    <div class="profile-header">
        <div class="avatar-container">
            <div class="avatar-main" id="picBox">?</div>
            <label for="imgInput" class="cam-icon" id="camBtn">üì∑</label>
            <input type="file" id="imgInput" style="display:none" accept="image/*" onchange="uploadImage(this)">
        </div>
        <h2 class="user-name" id="dispName">...</h2>
        <div class="info-text" id="dispEmail">...</div>
        <div class="info-text" id="dispPhone">...</div>
    </div>

    <div class="menu-list">
        <div class="menu-item" onclick="enableEditMode()">
            <span>‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</span>
            <span>‚úèÔ∏è</span>
        </div>

        <div id="editArea" class="edit-area">
            <input type="text" id="newName" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶®‡¶æ‡¶Æ">
            <input type="email" id="newEmail" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶á‡¶Æ‡ßá‡¶á‡¶≤">
            <input type="text" id="newPhone" placeholder="‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞">
            <button class="save-btn" onclick="saveChanges()">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>

        <div class="menu-item" onclick="logout()">
            <span>‡¶≤‡¶ó ‡¶Ü‡¶â‡¶ü</span>
            <span>‚Ü™Ô∏è</span>
        </div>

        <div class="menu-item delete-box" onclick="deleteAccount()">
            <span>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡ßÅ‡¶®</span>
            <span>üóëÔ∏è</span>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD_7v6rBHjVLHVK5OGiJpkgBzAuaJO8vn0",
        authDomain: "boi-baz-v2.firebaseapp.com",
        projectId: "boi-baz-v2",
        appId: "1:573343324145:web:42899dd75501af36985650"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const myCode = localStorage.getItem("usercode");

    let presenceTimer;

    window.onload = function() {
        if(!myCode) { window.location.href="login.html"; return; }
        updateStatus('online');
        loadData();
    }

    // --- ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶ìVisibility ‡¶≤‡¶ú‡¶ø‡¶ï ---
    function updateStatus(st) {
        if(myCode) db.collection("users").doc(myCode).update({ 
            status: st, 
            lastSeen: firebase.firestore.FieldValue.serverTimestamp() 
        });
    }

    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === 'hidden') {
            presenceTimer = setTimeout(() => updateStatus('offline'), 2000);
        } else {
            clearTimeout(presenceTimer);
            updateStatus('online');
        }
    });

    function loadData() {
        db.collection("users").doc(myCode).onSnapshot(doc => {
            if(doc.exists) {
                const d = doc.data();
                document.getElementById('dispName').innerText = d.userName;
                document.getElementById('dispEmail').innerText = d.userEmail || "‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶®‡ßá‡¶á";
                document.getElementById('dispPhone').innerText = d.phone || "‡¶´‡ßã‡¶® ‡¶®‡ßá‡¶á";
                if(d.profilePic) document.getElementById('picBox').innerHTML = `<img src="${d.profilePic}">`;
                else document.getElementById('picBox').innerText = d.userName.charAt(0).toUpperCase();
            }
        });
    }

    function enableEditMode() {
        document.getElementById('editArea').style.display = "block";
        document.getElementById('camBtn').style.display = "block";
    }

    function saveChanges() {
        const n = document.getElementById('newName').value;
        const e = document.getElementById('newEmail').value;
        const p = document.getElementById('newPhone').value;
        let obj = {};
        if(n) obj.userName = n;
        if(e) obj.userEmail = e;
        if(p) obj.phone = p;

        db.collection("users").doc(myCode).update(obj).then(() => {
            alert("‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
            document.getElementById('editArea').style.display = "none";
        });
    }

    function uploadImage(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onloadend = () => db.collection("users").doc(myCode).update({ profilePic: reader.result });
        if(file) reader.readAsDataURL(file);
    }

    function logout() { 
        updateStatus('offline');
        localStorage.clear(); 
        window.location.href="login.html"; 
    }

    // --- ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ---
    function deleteAccount() {
        const confirmDel = confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡¶ü‡¶ø ‡¶ö‡¶ø‡¶∞‡¶§‡¶∞‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶ï‡¶≤ ‡¶§‡¶•‡ßç‡¶Ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶π‡ßü‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§");
        if(confirmDel) {
            db.collection("users").doc(myCode).delete().then(() => {
                alert("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡¶ü‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§");
                localStorage.clear();
                window.location.href = "login.html";
            }).catch(err => alert("‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá: " + err));
        }
    }

    function goToChat() { window.location.href = "mass.html"; }
</script>
</body>
</html>
