<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Messenger - Home</title>
    <link rel="icon" type="image/png" href="logo.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0084ff">

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #fff; margin: 0; display: flex; justify-content: center; overflow-x: hidden; }
        
        .app-frame { width: 100%; max-width: 500px; height: 100vh; display: flex; flex-direction: column; background: white; }
        
        header { 
            padding: 10px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid #f0f2f5; 
            position: sticky; top: 0; background: white; z-index: 100;
        }
        .logo-area { display: flex; align-items: center; gap: 10px; }
        .app-logo-img { width: 35px; height: 35px; border-radius: 8px; object-fit: cover; }
        .logo-text { font-size: 24px; font-weight: 800; color: #0084ff; letter-spacing: -1px; }

        .profile-wrapper { display: flex; flex-direction: column; align-items: center; cursor: pointer; text-decoration: none; }
        .profile-icon { width: 38px; height: 38px; background: #f0f2f5; border-radius: 50%; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1px solid #ddd; }
        .profile-icon img { width: 100%; height: 100%; object-fit: cover; }
        .login-label { font-size: 10px; color: #0084ff; font-weight: bold; margin-top: 2px; }

        .container { flex: 1; padding: 0 15px; overflow-y: auto; }
        .search-area { padding: 12px 0; background: white; }
        .search-input { width: 100%; padding: 12px 18px; border-radius: 25px; border: none; background: #f0f2f5; outline: none; font-size: 16px; }

        .user-item { display: flex; align-items: center; padding: 12px 10px; border-radius: 15px; cursor: pointer; margin-bottom: 5px; transition: 0.2s; }
        .user-item:active { background: #f0f2f5; }
        
        .avatar-wrapper { position: relative; margin-right: 15px; }
        .avatar { width: 55px; height: 55px; background: #0084ff; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; overflow: hidden; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        
        .online-dot { 
            position: absolute; bottom: 3px; right: 3px; 
            width: 14px; height: 14px; background: #31a24c; 
            border: 2px solid white; border-radius: 50%; 
        }

        .user-details { flex: 1; border-bottom: 1px solid #f0f2f5; padding-bottom: 10px; }
        .user-name { font-size: 16px; font-weight: 600; color: #050505; margin: 0; }
        .last-msg { font-size: 13px; color: #65676b; margin-top: 3px; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 200px; }

        .hidden { display: none !important; }
        #view-p1 { text-align: center; padding: 60px 20px; }
    </style>
</head>
<body>

<div class="app-frame">
    <header>
        <div class="logo-area">
            <img src="logo.png" alt="Logo" class="app-logo-img" onerror="this.src='https://cdn-icons-png.flaticon.com/512/5968/5968771.png'">
            <div class="logo-text">Chats</div>
        </div>
        
        <div onclick="navigateTo('pro.html')" class="profile-wrapper" id="profileLink" style="display: none;">
            <div class="profile-icon" id="profileIconBox">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#65676b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            </div>
        </div>
        <a href="login.html" class="profile-wrapper" id="loginBtn">
            <span class="login-label">Login</span>
        </a>
    </header>

    <div class="container">
        <div id="view-p1">
            <div style="font-size: 50px; margin-bottom: 10px;">üëã</div>
            <h2 style="color: #050505; margin: 0;">Messenger-‡¶è ‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ</h2>
            <p style="color: #65676b;">‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶§‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
        </div>

        <div id="view-p2" class="hidden">
            <div class="search-area">
                <input type="text" id="searchBox" class="search-input" placeholder="Search..." oninput="handleSearch()">
            </div>
            <div id="chatList"></div>
            <div id="searchResults" class="hidden"></div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD_7v6rBHjVLHVK5OGiJpkgBzAuaJO8vn0",
        authDomain: "boi-baz-v2.firebaseapp.com",
        projectId: "boi-baz-v2",
        appId: "1:573343324145:web:42899dd75501af36985650"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const myCode = localStorage.getItem("usercode");
    const myName = localStorage.getItem("username");

    // --- ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï ‡¶¨‡¶æ‡¶ü‡¶® ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤ (‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡ßá‡¶∞ ‡¶π‡¶ì‡ßü‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø) ---
   function initBackControl() {
    // ‡¶è‡¶ü‡¶ø ‡ß® ‡¶¨‡¶æ‡¶∞ ‡¶™‡ßÅ‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶Ø‡¶æ‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï ‡¶¨‡¶æ‡¶ü‡¶® ‡¶ö‡¶æ‡¶™‡¶≤‡ßá ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞ ‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶∂‡ßá‡¶∑ ‡¶π‡ßü‡ßá ‡¶Ø‡¶æ‡ßü
    window.history.pushState({page: 1}, "", "");
    window.history.pushState({page: 2}, "", "");

    window.onpopstate = function(event) {
        // ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï ‡¶¨‡¶æ‡¶ü‡¶® ‡¶ö‡¶æ‡¶™‡¶≤‡ßá ‡¶è‡¶ü‡¶ø ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶¨‡ßá‡•§ ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶á‡¶â‡¶ú‡¶æ‡¶∞‡¶ï‡ßá ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶¶‡ßá‡¶¨ ‡¶¨‡¶æ ‡¶π‡ßã‡¶Æ‡ßá‡¶á ‡¶Ü‡¶ü‡¶ï‡ßá ‡¶∞‡¶æ‡¶ñ‡¶¨‡•§
        window.history.pushState({page: 2}, "", "");
        // ‡¶ö‡¶æ‡¶á‡¶≤‡ßá ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ‡ßá‡¶∂‡¶® ‡¶™‡¶™‡¶Ü‡¶™ ‡¶¶‡¶ø‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶® "‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡ßá‡¶∞ ‡¶π‡¶§‡ßá ‡¶ö‡¶æ‡¶®?"
    };
}

    // --- ‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶®/‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï ---
    function setOnline() {
        if (!myCode) return;
        const pendingTimer = localStorage.getItem('offTimerId');
        if (pendingTimer) {
            clearTimeout(Number(pendingTimer));
            localStorage.removeItem('offTimerId');
        }
        db.collection("users").doc(myCode).update({
            status: 'online',
            lastSeen: firebase.firestore.FieldValue.serverTimestamp(),
            currentChat: ''
        });
    }


    function setOffline() {
        if (!myCode) return;
        const timerId = setTimeout(() => {
            db.collection("users").doc(myCode).update({ 
                status: 'offline', currentChat: '', typingWith: ""
            });
            localStorage.removeItem('offTimerId');
        }, 3000); // ‡ß© ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶°‡¶ø‡¶≤‡ßá
        localStorage.setItem('offTimerId', timerId);
    }


// ‡¶è‡¶á ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶ü‡¶ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® ‡¶ï‡¶≤ ‡¶∏‡¶∞‡¶ø‡ßü‡ßá ‡¶¶‡¶ø‡¶®)
function navigateTo(url) {
    // ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶®‡ßá‡¶≠‡¶ø‡¶ó‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶® ‡¶π‡¶ì‡ßü‡¶æ‡¶∞ ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞ ‡¶®‡ßá‡¶á ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá‡¶á ‡¶Ü‡¶õ‡ßá‡¶®
    window.location.href = url; 
}

    window.onload = function() {
        initBackControl();
        if (myCode && myName) {
            document.getElementById('view-p1').classList.add('hidden');
            document.getElementById('view-p2').classList.remove('hidden');
            document.getElementById('loginBtn').classList.add('hidden');
            document.getElementById('profileLink').style.display = "flex";
            
            setOnline();
            loadMyProfile();
            loadChatHistory();
        }
    };

    // ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶è‡¶¨‡¶Ç ‡¶™‡¶ø‡¶∏‡¶ø‡¶∞ ‡¶∏‡¶¨ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶ó‡ßç‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶° ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤ ‡¶ï‡¶∞‡¶æ
    window.addEventListener('pagehide', setOffline);
    window.addEventListener('beforeunload', setOffline);
   // ‡¶â‡¶≠‡ßü ‡¶™‡ßá‡¶ú‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø‡¶á ‡¶è‡¶á ‡¶≤‡¶ú‡¶ø‡¶ï‡¶ü‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === 'hidden') {
        // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ø‡¶ñ‡¶® ‡¶π‡ßã‡¶Æ ‡¶¨‡¶æ‡¶ü‡¶® ‡¶ö‡¶æ‡¶™‡ßá ‡¶§‡¶ñ‡¶® ‡¶è‡¶ü‡¶ø ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶¨‡ßá
        setOffline();
    } else {
        // ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ø‡¶ñ‡¶® ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßá ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ü‡¶∏‡ßá
        setOnline();
    }
});

    // --- ‡¶°‡¶æ‡¶ü‡¶æ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶∏ ---
    function loadMyProfile() {
        db.collection("users").doc(myCode).onSnapshot(doc => {
            if (doc.exists && doc.data().profilePic) {
                document.getElementById('profileIconBox').innerHTML = `<img src="${doc.data().profilePic}">`;
            }
        });
    }

    function loadChatHistory() {
        db.collection("chats").where("receiverCode", "==", myCode).onSnapshot(s => s.forEach(doc => fetchUser(doc.data().senderCode, doc.data().lastMsg)));
        db.collection("chats").where("senderCode", "==", myCode).onSnapshot(s => s.forEach(doc => fetchUser(doc.data().receiverCode, "You: " + doc.data().lastMsg)));
    }

    function fetchUser(code, lastMsg) {
        db.collection("users").doc(code).onSnapshot(doc => {
            if(doc.exists) {
                const data = doc.data();
                renderUserItem(data.userName, data.userCode, lastMsg, data.profilePic, data.status);
            }
        });
    }

    function renderUserItem(name, code, msg, pic, status) {
        let old = document.getElementById('u-' + code);
        if (old) old.remove();

        const div = document.createElement('div');
        div.className = 'user-item';
        div.id = 'u-' + code;
        
        let avatarContent = pic ? `<img src="${pic}">` : name.charAt(0).toUpperCase();
        div.innerHTML = `
            <div class="avatar-wrapper">
                <div class="avatar">${avatarContent}</div>
                ${status === 'online' ? '<div class="online-dot"></div>' : ''}
            </div>
            <div class="user-details">
                <p class="user-name">${name}</p>
                <span class="last-msg">${msg}</span>
            </div>
        `;
        
        div.onclick = () => {
            localStorage.setItem("chatTargetName", name);
            localStorage.setItem("chatTargetCode", code);
            navigateTo("mass.html");
        };
        document.getElementById('chatList').prepend(div);
    }

    function handleSearch() {
        const query = document.getElementById('searchBox').value.trim();
        const resultsDiv = document.getElementById('searchResults');
        const chatListDiv = document.getElementById('chatList');
        if (!query) { resultsDiv.classList.add('hidden'); chatListDiv.classList.remove('hidden'); return; }
        chatListDiv.classList.add('hidden');
        resultsDiv.classList.remove('hidden');
        db.collection("users").where("userName", ">=", query).where("userName", "<=", query + "\uf8ff").get().then(snap => {
            resultsDiv.innerHTML = "<p style='padding:10px; font-size:12px; color:#65676b;'>Search Results</p>";
            snap.forEach(doc => {
                if(doc.id !== myCode) renderSearchItem(doc.data().userName, doc.id, doc.data().profilePic, doc.data().status);
            });
        });
    }

    function renderSearchItem(name, code, pic, status) {
        const resultsDiv = document.getElementById('searchResults');
        const div = document.createElement('div');
        div.className = 'user-item';
        div.innerHTML = `
            <div class="avatar-wrapper">
                <div class="avatar">${pic ? `<img src="${pic}">` : name.charAt(0).toUpperCase()}</div>
                ${status === 'online' ? '<div class="online-dot"></div>' : ''}
            </div>
            <div class="user-details">
                <p class="user-name">${name}</p>
                <span class="last-msg">Messenger User</span>
            </div>
        `;
        div.onclick = () => {
            localStorage.setItem("chatTargetName", name);
            localStorage.setItem("chatTargetCode", code);
            navigateTo("mass.html");
        };
        resultsDiv.appendChild(div);
    }
</script>
</body>
</html>
